import json
import os
from typing import Dict, Any

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    """
    Webhook –¥–ª—è MAX –±–æ—Ç–∞ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã
    """
    method = event.get('httpMethod', 'POST')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Max-Age': '86400'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    try:
        body = json.loads(event.get('body', '{}'))
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç MAX
        message_text = body.get('text', '').strip()
        user_id = body.get('from', {}).get('id', '')
        chat_id = body.get('chat', {}).get('id', '')
        message_type = body.get('type', '')
        
        print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç user_id={user_id}, chat_id={chat_id}: {message_text}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–∞–Ω–¥—ã
        response_text = ""
        
        if message_text.lower() in ['/start', 'start', '–Ω–∞—á–∞—Ç—å', '–ø—Ä–∏–≤–µ—Ç']:
            response_text = f"""üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ì–ë–£–ó ¬´–ê–Ω—Ç—Ä–∞—Ü–∏—Ç–æ–≤—Å–∫–∞—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≥–æ—Ä–æ–¥—Å–∫–∞—è –º–Ω–æ–≥–æ–ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞¬ª –õ–ù–†!

–Ø –±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º –∫ –≤—Ä–∞—á–∞–º.

üîπ –ß–µ—Ä–µ–∑ –Ω–∞—à —Å–∞–π—Ç –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º
üîπ –Ø –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤–∞–º –∫–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏
üîπ –í—Å–µ –∫–æ–¥—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 10 –º–∏–Ω—É—Ç

–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º:
1Ô∏è‚É£ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –±–æ–ª—å–Ω–∏—Ü—ã
2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
3Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
4Ô∏è‚É£ –Ø –ø—Ä–∏—à–ª—é –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—é–¥–∞, –≤ —ç—Ç–æ—Ç —á–∞—Ç

üìû –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –∑–≤–æ–Ω–∏—Ç–µ: +7-857-312-51-02"""
        
        elif message_text.lower() in ['–ø–æ–º–æ—â—å', 'help', '/help']:
            response_text = """‚ÑπÔ∏è –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:

1Ô∏è‚É£ –ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –±–æ–ª—å–Ω–∏—Ü—ã
2Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º"
3Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ –∏ –≤—Ä–µ–º—è
4Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ç–æ—Ç, —á—Ç–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ú–ê–ö–°)
5Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ –≤ —ç—Ç–æ–º —á–∞—Ç–µ
6Ô∏è‚É£ –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∞ —Å–∞–π—Ç–µ

‚ùó –í–∞–∂–Ω–æ: –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–æ–º–µ—Ä–æ–º –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ –ú–ê–ö–°

üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –±–æ–ª—å–Ω–∏—Ü—ã: +7-857-312-51-02"""
        
        elif message_text.lower() in ['–∫–æ–Ω—Ç–∞–∫—Ç—ã', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–∞–¥—Ä–µ—Å']:
            response_text = """üìç –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:

üìû –ü—Ä–∏–µ–º–Ω–∞—è –≥–ª–∞–≤–Ω–æ–≥–æ –≤—Ä–∞—á–∞: +7-857-312-51-02
üìû –ö–æ–º–º—É—Ç–∞—Ç–æ—Ä: +7-857-312-60-57
üìß Email: antrasit_1gorbolnica@mail.ru

üè• –ê–¥—Ä–µ—Å: 294613, –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è, –õ—É–≥–∞–Ω—Å–∫–∞—è –ù–∞—Ä–æ–¥–Ω–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞, –≥–æ—Ä–æ–¥ –ê–Ω—Ç—Ä–∞—Ü–∏—Ç, —É–ª–∏—Ü–∞ –¢–æ–ª—Å—Ç–æ—É—Å–æ–≤–∞, –¥–æ–º 1

‚è∞ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: –ü–Ω-–ü—Ç 09:00-17:00"""
        
        else:
            response_text = """–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! 

–Ø –±–æ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–æ–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
‚Ä¢ /start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
‚Ä¢ –ø–æ–º–æ—â—å - –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
‚Ä¢ –∫–æ–Ω—Ç–∞–∫—Ç—ã - –∫–æ–Ω—Ç–∞–∫—Ç—ã –±–æ–ª—å–Ω–∏—Ü—ã

–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –±–æ–ª—å–Ω–∏—Ü—ã."""
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (MAX API —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({
                'type': 'text',
                'text': response_text,
                'chat_id': chat_id
            }),
            'isBase64Encoded': False
        }
    
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook: {type(e).__name__}: {str(e)}")
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'ok': True}),
            'isBase64Encoded': False
        }
